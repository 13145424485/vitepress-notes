# Mapper与Service层

| 层级    | 关注点                             | 例子                                         |
| ------- | ---------------------------------- | -------------------------------------------- |
| Mapper  | 与表一一对应的 **物理 SQL**        | `SELECT * FROM sys_role WHERE …`             |
| Service | **业务规则**、数据加工、权限判断等 | “若当前用户非超级管理员，则追加部门过滤条件” |

Mapper` 只负责“把数据按指定条件从数据库取出来”，不做业务逻辑；真正的逻辑查询（业务规则、数据权限、结果裁剪）放在 Service 层完成

```
graph TD
    A[前端/客户端] --> B[Controller层 - 控制器]
    B --> C[Service层 - 业务逻辑]
    C --> D[Mapper层 - 数据访问]
    D --> E[数据库]
    
    F[Entity层 - 实体类] --> B
    F --> C
    F --> D
    
    style A fill:#e1f5fe
    style B fill:#f3e5f5
    style C fill:#e8f5e8
    style D fill:#fff3e0
    style E fill:#ffebee
    style F fill:#f1f8e9
```

## 1. 实体类（Entity层）- 数据模型

**SysUser.java - 用户实体类**

```
package com.doc.web.sys_user.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import java.math.BigDecimal;
import java.util.Collection;
import java.util.Date;

@Data
@TableName("sys_user")
public class SysUser implements UserDetails {

    //声明“这是主键，并且它的值由数据库自增”。
    @TableId(type = IdType.AUTO)
    private Long userId;
    //表明roleId字段不属于sys_user表，需要排除
    @TableField(exist = false)
    private Long roleId;
    private String username;
    private String password;
    private String phone;
    private String email;
    private String sex;
    private String isAdmin;
    //类型（1：员工 2：教练）
    private String userType;
    //状态 0：停用 1：启用
    private String status;
    private BigDecimal salary;
    private String nickName;
    //创建时间
    private Date createTime;
    //更新时间
    private Date updateTime;
    //帐户是否过期(1 未过期，0已过期)
    private boolean isAccountNonExpired = true;
    //帐户是否被锁定(1 未锁定，0已锁定)
    private boolean isAccountNonLocked = true;
    //密码是否过期(1 未过期，0已过期)
    private boolean isCredentialsNonExpired = true;
    //帐户是否可用(1 可用，0 删除用户)
    private boolean isEnabled = true;
    //用户权限字段的集合 authorities字段不属于sys_user表，需要排除
    //(exist = false) → 注解参数；给注解的 exist 属性赋值 false，告诉框架“这个字段在表里不存在”。
    @TableField(exist = false)
    Collection<? extends GrantedAuthority> authorities;
}
```

- `@Data`：这是Lombok注解，自动生成getter、setter、toString、equals、hashCode方法
- `@TableName("sys_user")`：MyBatis-Plus注解，指定对应的数据库表名
- `implements UserDetails`：实现Spring Security的用户详情接口，用于权限认证

- `@TableId(type = IdType.AUTO)`：标记主键，AUTO表示数据库自增
- `@TableField(exist = false)`：表示该字段不在数据库表中，仅用于业务逻辑

**PageParam.java - 分页参数类**

```
package com.doc.web.sys_user.entity;

import lombok.Data;
@Data
public class PageParam {
    private Long currentPage;  // 当前页码
    private Long pageSize;     // 每页大小
    private String phone;      // 查询条件：手机号
    private String nickName;   // 查询条件：昵称
}

```

## 2. 数据访问层（Mapper层）

```
public interface SysUserMapper extends BaseMapper<SysUser> {
}
```

- `interface`：Java接口，定义方法签名但不实现

- `extends BaseMapper`：继承MyBatis-Plus的基础Mapper

- `BaseMapper`

  提供了基本的CRUD操作：

  - `insert()` - 插入
  - `deleteById()` - 根据ID删除
  - `updateById()` - 根据ID更新
  - `selectById()` - 根据ID查询
  - `selectList()` - 查询列表
  - 等等...

## 3. 业务逻辑层（Service层）

**SysUserService.java - 业务接口**

```
package com.doc.web.sys_user.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.doc.web.sys_user.entity.PageParam;
import com.doc.web.sys_user.entity.SysUser;
//声明一个用户业务接口，它天生自带 MyBatis-Plus 的全部单表 CRUD 能力，额外方法自己再补
public interface SysUserService extends IService<SysUser> {

    IPage<SysUser> list(PageParam param);

    //根据员工姓名查询员工信息
    SysUser loadUser(String username);

}

```



- `extends IService`：继承MyBatis-Plus的服务接口，获得基础CRUD能力
- `IPage`：分页结果接口，包含数据和分页信息

**SysUserServiceImpl.java - 业务实现类**

```
package com.doc.web.sys_user.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.doc.web.sys_user.entity.PageParam;
import com.doc.web.sys_user.entity.SysUser;
import com.doc.web.sys_user.mapper.SysUserMapper;
import com.doc.web.sys_user.service.SysUserService;
import org.apache.commons.lang.StringUtils;
import org.springframework.stereotype.Service;

@Service
//拿到通用 CRUD；泛型 <Mapper, Entity> 指定操作谁
public class SysUserServiceImpl extends ServiceImpl<SysUserMapper, SysUser> implements SysUserService {
    @Override
    public IPage<SysUser> list(PageParam param) {
        // 实现分页查询逻辑,构造分页对象
        // 这里可以使用 MyBatis-Plus 的分页查询方法
        IPage<SysUser> page = new Page<>();
        page.setSize(param.getPageSize());
        page.setCurrent(param.getCurrentPage());
        //构造查询条件
        //动态 SQL 条件构造器 QueryWrapper
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        //Spring 的判空工具
        if(StringUtils.isNotEmpty(param.getNickName())){
            query.lambda().like(SysUser::getNickName, param.getNickName());
        }

        if(StringUtils.isNotEmpty(param.getPhone())){
            query.lambda().like(SysUser::getPhone, param.getPhone());
        }

        return this.baseMapper.selectPage(page, query);
    }

    @Override
    public SysUser loadUser(String username) {
        // 根据用户名查询用户信息
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        query.lambda().eq(SysUser::getUsername, username);
        return this.baseMapper.selectOne(query);
    }
}

```

- `@Service`：Spring注解，标记为服务层组件，会被Spring容器管理
- `abstract class`：抽象类，可以有具体实现，也可以有抽象方法
- `ServiceImpl`：MyBatis-Plus提供的服务实现基类

- `StringUtils.isNotEmpty()`：判断字符串非空
- `query.lambda().like()`：Lambda表达式构造模糊查询条件
- `SysUser::getNickName`：方法引用，指向getNickName方法

## 4. 控制器层（Controller层）

```
package com.doc.web.sys_user.controller;


import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.doc.utils.ResultUtils;
import com.doc.utils.ResultVo;
import com.doc.web.sys_role.service.SysRoleService;
import com.doc.web.sys_user.entity.PageParam;
import com.doc.web.sys_user.entity.SysUser;
import com.doc.web.sys_user.service.SysUserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import org.apache.commons.lang.StringUtils;
import org.springframework.util.DigestUtils;

import java.util.Date;

@RestController
@RequestMapping("/api/user")
public class SysUserController {
    @Autowired
    private SysUserService sysUserService;

    @Autowired
    private SysRoleService sysRoleaService;

    //新增员工
    @PostMapping
    public ResultVo addUser(@RequestBody SysUser sysUser) {
        //判断用户名字是否存在
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        //指定列，指定值
        query.lambda().eq(SysUser::getNickName, sysUser.getNickName());
        SysUser one = sysUserService.getOne(query);
        if (one != null) {
            return ResultUtils.error("员工名称已存在，请重新输入");
        }

        //密码加密
        if (StringUtils.isNotEmpty(sysUser.getPassword())) {
            sysUser.setPassword(DigestUtils.md5DigestAsHex(sysUser.getPassword().getBytes()));

        }
        //设置默认角色
        sysUser.setIsAdmin("0");
        sysUser.setCreateTime(new Date());
        //存储到数据库中
        boolean save = sysUserService.save(sysUser);
        if (save) {
            return ResultUtils.success("新增用户成功");
        }

        return ResultUtils.error("新增用户失败");

    }

    //编辑员工
    @PutMapping
    public ResultVo editUser(@RequestBody SysUser sysUser) {
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        //指定列，指定值
        query.lambda().eq(SysUser::getUsername, sysUser.getUsername());
        SysUser one = sysUserService.getOne(query);
        if(one != null && one.getUserId()!= sysUser.getUserId()){
            return ResultUtils.error("用户名已存在，请重新输入");
        }
        //密码加密
        if (StringUtils.isNotEmpty(sysUser.getPassword())) {
            sysUser.setPassword(DigestUtils.md5DigestAsHex(sysUser.getPassword().getBytes()));

        }
        sysUser.setUpdateTime(new Date());
        //存入数据库
        boolean save = sysUserService.updateById(sysUser);
        if (save) {
            return ResultUtils.success("编辑用户成功");
        }

        return ResultUtils.error("编辑用户失败");

    }

    //删除员工
    @DeleteMapping("/{userId}")
    public ResultVo deleteUser(@PathVariable("userId") Long userId) {
        boolean remove = sysUserService.removeById(userId);
        if (remove) {
            return ResultUtils.success("删除用户成功");
        }
        return ResultUtils.error("删除用户失败");
    }

    //查询用户列表
    @GetMapping("/list")
    public ResultVo getlist(PageParam param) {
        IPage<SysUser> list = sysUserService.list(param);
        //查询出来不显示密码
        list.getRecords().forEach(user -> user.setPassword(null));
        return ResultUtils.success("查询成功", list);
    }
    //根据用户id查询角色id
    @GetMapping("/role")
    public ResultVo getRole(@RequestParam("userId") Long userId) {
        //查询用户角色
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        query.lambda().eq(SysUser::getUserId, userId);
        SysUser sysUser = sysUserService.getOne(query);
        if (sysUser == null) {
            return ResultUtils.error("用户不存在");
        }
        return ResultUtils.success("查询成功", sysUser.getRoleId());
    }

}

```

- `@RestController`：Spring注解，等于`@Controller + @ResponseBody`，返回JSON数据
- `@RequestMapping("/api/user")`：定义基础URL路径

- `@Autowired`：Spring自动装配注解，自动注入Service实例

**新增用户方法详解：**

```
@PostMapping
public ResultVo addUser(@RequestBody SysUser sysUser) {
    // 检查用户名是否存在
    QueryWrapper<SysUser> query = new QueryWrapper<>();
    query.lambda().eq(SysUser::getNickName, sysUser.getNickName());
    SysUser one = sysUserService.getOne(query);
```

- `@PostMapping`：处理POST请求
- `@RequestBody`：将请求体JSON转换为Java对象
- `ResultVo`：统一返回结果封装类

- `@PathVariable`：获取URL路径中的变量
- `@RequestParam`：获取请求参数







### @Autowired的核心作用

#### 1. **自动依赖注入**

简单来说，`@Autowired`帮你自动"找到"并"注入"需要的对象，你不需要手动创建。

让我用一个生活中的例子来解释：

```
// 没有@Autowired的情况（手动创建）
public class SysUserController {
    private SysUserService sysUserService;
    
    public SysUserController() {
        // 你需要手动创建Service对象
        this.sysUserService = new SysUserServiceImpl();
        // 但是SysUserServiceImpl又需要SysUserMapper
        // 你还得手动创建Mapper...
        // 这样一层层创建下去，非常麻烦！
    }
}
```

创建Controller时

- Spring看到`@Autowired`注解
- 从容器中找到`SysUserService`类型的实例（就是`SysUserServiceImpl`）
- 自动注入到`sysUserService`字段中